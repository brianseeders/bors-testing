on:
  issue_comment:
    types: [created]

jobs:
  pr_merge:
    # This job only runs for pull request comments
    name: PR Merge
    if: |
      github.event.issue.pull_request && github.event.comment.body == '/merge' && github.event.comment.user.login == 'brianseeders'
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Squash commits
        run: |
          gh pr checkout "$PR_NUMBER"
          SHA=$(git rev-parse HEAD)
          git reset --hard main
          git checkout "$SHA" .
          git commit --author="${{ github.event.issue.user.login }} <${{ github.event.issue.user.id }}+${{ github.event.issue.user.login }}@users.noreply.github.com>" -m "$PR_TITLE #$PR_NUMBER"
          git push -f
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.issue.number }}
          PR_TITLE: ${{ github.event.issue.title }}
